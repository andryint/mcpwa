#!/bin/bash
# installer/scripts/postinstall

# Get the actual console user (not root)
CONSOLE_USER=$(stat -f "%Su" /dev/console)
USER_HOME=$(eval echo ~$CONSOLE_USER)

CLAUDE_CONFIG_DIR="$USER_HOME/Library/Application Support/Claude"
CLAUDE_CONFIG="$CLAUDE_CONFIG_DIR/claude_desktop_config.json"
SHIM_PATH="/Applications/mcpwa.app/Contents/MacOS/mcp-shim"

# Create directory if needed
mkdir -p "$CLAUDE_CONFIG_DIR"
chown "$CONSOLE_USER" "$CLAUDE_CONFIG_DIR"

# Modify config with Python
/usr/bin/python3 << EOF
import json

config_path = "$CLAUDE_CONFIG"
shim_path = "$SHIM_PATH"

try:
    with open(config_path, 'r') as f:
        config = json.load(f)
except (FileNotFoundError, json.JSONDecodeError):
    config = {}

if 'mcpServers' not in config:
    config['mcpServers'] = {}

config['mcpServers']['mcpwa'] = {
    "command": shim_path,
    "args": []
}

with open(config_path, 'w') as f:
    json.dump(config, f, indent=2)
EOF

# Ensure correct ownership
chown "$CONSOLE_USER" "$CLAUDE_CONFIG"

# Show success message
osascript -e 'display dialog "mcpwa has been installed successfully.\n\nPlease quit and relaunch Claude Desktop to activate the WhatsApp integration." with title "mcpwa Installer" buttons {"OK"} default button "OK" with icon note'

exit 0
